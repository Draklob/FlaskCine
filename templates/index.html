<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cines - Información</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css"
          rel="stylesheet" integrity="sha384-SgOJa3DmI69IUzQ2PVdRZhwQ+dy64/BUtbMJw1MZ8t5HZApcHrRKUc4W0kG879m7" crossorigin="anonymous">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="contenedor-cine row">
        <!-- Menú lateral -->
        <aside class="sidebar col no-gutters">
            <div class="cines-lista-cabecera align-content-center">
                <h2 class="titulos">Cines</h2>
            </div>
            <nav class="nav-contenedor">
                <ul id="cines-lista" class="cines-lista"></ul>
            </nav>
        </aside>

        <!-- Área de contenido -->
        <main class="contenedor-main col no-gutters">
            <section class="pb-5">
                <div id="cine-detalles" class="detalles-container mx-auto">
                    <h2 class="titulos">Selecciona un cine</h2>
                    <p>Haz clic en un cine de la lista para ver sus detalles.</p>
                </div>
            </section>
            <div id="contenedor-peliculas-cine" class="row">
                <section class="peliculas-cine col">
                    <div id="detalles-peliculas" class="">
                        <h2 class="titulos">Cartelera</h2>
                        <div id="peliculas-lista" class="grid-peliculas"></div>
                    </div>
                </section>
                <section class="peliculas-info col">
                    <h2 class="titulos">Info</h2>
                </section>
            </div>
        </main>
    </div>

    <script>
        // Estado de la aplicación
        const appState = {
            cines: [],
            selectedCine: null,
            peliculas: [],
            selectedPelicula: null,
        };

        // Cargar cines desde el backend
        async function cargarCines() {
            try {
                const response = await fetch('/cines');
                if (!response.ok) throw new Error('Error al cargar cines');
                appState.cines = await response.json();
                renderizarMenu();
            } catch (error) {
                mostrarError('No se pudieron cargar los cines.');
                console.error(error);
            }
        }

        // Renderizar el menú de cines
        function renderizarMenu() {
            const lista = document.getElementById('cines-lista');
            lista.innerHTML = '';
            appState.cines.forEach(cine => {
                const li = document.createElement('li');
                li.className = `cine-item p-3 rounded ${appState.selectedCine && appState.selectedCine.id_cine === cine.id_cine ? 'active' : ''}`;
                li.textContent = cine.nombre;
                li.addEventListener('click', () => {
                    appState.selectedCine = cine;
                    renderizarMenu();
                    renderizarDetallesCine();
                    cargarPeliculas();
                });
                lista.appendChild(li);
            });
        }

        // Carga las pelis cuando elegimos el cine
        async function cargarPeliculas() {
            try{
                const response = await fetch(`/cines/${appState.selectedCine.id_cine}/peliculas`);
                if (!response.ok) throw new Error('Error al cargar las peliculas');
                appState.peliculas = await response.json();
                renderizarPeliculas();
            } catch (error) {
                mostrarError('No se pudieron cargar las peliculas.');
                console.error(error);
            }
        }

        // Renderizar los detalles del cine
        function renderizarDetallesCine() {
            const detalles = document.getElementById('cine-detalles');
            detalles.style.opacity = '0';
            setTimeout(() => {
                if (appState.selectedCine) {
                    const precioBase = appState.selectedCine.precio_base != null ? parseFloat(appState.selectedCine.precio_base) : null;
                    detalles.innerHTML = `
                        <h2 class="text-2xl font-bold mb-4 text-gray-800">${sanitize(appState.selectedCine.nombre)}</h2>
                        <p class="text-gray-600 mb-2"><strong>Dirección:</strong> ${sanitize(appState.selectedCine.direccion || 'No disponible')}</p>
                        <p class="text-gray-600 mb-2"><strong>Teléfono:</strong> ${sanitize(appState.selectedCine.telefono || 'No disponible')}</p>
                        <p class="text-gray-600"><strong>Precio:</strong> ${precioBase != null && !isNaN(precioBase) ? precioBase.toFixed(2) + ' €' : 'No disponible'}</p>
                        <p class="text-gray-600 mb-2"><strong>Numero de salas:</strong> ${appState.selectedCine.salas}</p>
                    `;
                } else {
                    detalles.innerHTML = `
                        <h2 class="text-2xl font-bold mb-4 text-gray-800">Selecciona un cine</h2>
                        <p class="text-gray-600">Haz clic en un cine de la lista para ver sus detalles.</p>
                    `;
                }
                detalles.style.opacity = '1';
            }, 300);
        }

        // Renderizar detalles de las peliculas en el cine elegido
        function renderizarPeliculas(){
            console.log(appState.peliculas);
            const contenedor = document.getElementById('peliculas-lista');
            contenedor.innerHTML = ''; // Limpia la lista
            contenedor.style.opacity = '0';
            setTimeout(() => {
                if (appState.selectedCine) {
                    appState.peliculas.forEach(peli => {
                        const item = document.createElement('div');
                        item.className = 'pelicula-item'
                        if( peli.poster_url && validarURL(peli.poster_url)) {
                            item.innerHTML = `
                                <img src="${peli.poster_url}" alt="${peli.titulo}" onerror="this.parentNode.innerHTML = '<h3>${escapeHtml(peli.titulo)}</h3>';
                                    this.nextElementSibling.style.display='block'">
                                <div class="pelicula-titulo" style="display: none;">
                                      ${peli.titulo}
                                </div>
                            `;
                        } else {
                            // Mostrar solo título en texto
                            item.innerHTML = `
                                <div class="pelicula-titulo">
                                    ${peli.titulo}
                                </div>
                            `;
                        }
                        item.addEventListener('click', () => {
                            appState.selectedPelicula = peli;
                            {#cargarInfoPeli#}
                            {#renderizarInfoPeli#}
                            console.log(appState.selectedPelicula);
                        });
                        contenedor.appendChild(item);
                    })
                } else {
                    contenedor.innerHTML = `
                        <h2 class="text-2xl font-bold mb-4 text-gray-800">Selecciona una pelicula.</h2>
                        <p class="text-gray-600">Haz clic en una pelicula de la lista para ver sus detalles.</p>
                    `;
                }
                contenedor.style.opacity = '1';
            }, 350);
        }

        // Validar URLs
        function validarURL(url) {
            try {
                new URL(url);
                return true;
            }
            catch (_){ return false; }
        }

        // Funcion para escapar HTML (Seguridad) para prevenir XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Mostrar mensaje de error
        function mostrarError(mensaje) {
            const detalles = document.getElementById('cine-detalles');
            detalles.innerHTML = `
                <h2 class="text-2xl font-bold mb-4 text-red-600">Error</h2>
                <p class="text-gray-600">${sanitize(mensaje)}</p>
            `;
        }

        // Sanitizar texto para prevenir XSS
        function sanitize(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        window.addEventListener('load', cargarCines);
        // Inicializar
        //cargarCines();
    </script>
</body>
</html>